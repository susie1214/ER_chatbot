<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ER-NOW 119</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@500;700;900&display=swap" rel="stylesheet">
</head>
<body>
<header class="hdr glass">
  <div class="brand">
    <svg class="ico hosp" viewBox="0 0 24 24" width="26" height="26" aria-hidden="true">
      <path d="M3 21V7a2 2 0 0 1 2-2h4V3h6v2h4a2 2 0 0 1 2 2v14h-4v-4H7v4H3zM9 9v2h2v2h2v-2h2V9h-2V7h-2v2H9z" fill="currentColor"/>
    </svg>
    <span class="brand-text">ER-NOW 119</span>
  </div>
  <div class="right">
    <button class="btn outline" id="btnPB" onclick="togglePB()">ğŸ“š í”Œë ˆì´ë¶</button>
    <button class="btn danger" onclick="tel119()">ğŸš‘ 119</button>
    <select id="lang" class="btn outline">
      <option value="ko">KOR</option><option value="en">ENG</option>
      <option value="zh">ä¸­æ–‡</option><option value="ja">æ—¥æœ¬èª</option>
    </select>
    <label class="switch">
      <input id="ttsAuto" type="checkbox" checked/> ğŸ”ˆì½ì–´ì£¼ê¸°
    </label>
    <button id="btnSTT" class="btn outline" onclick="toggleSTT()">ğŸ™ï¸ ë§í•˜ê¸°</button>
  </div>
</header>

<!-- ì¢Œì¸¡ ì ‘ì´ì‹ í”Œë ˆì´ë¶ íŒ¨ë„ -->
<aside id="playbook" class="pb glass" hidden>
  <div class="pb-head">
    <b>ìƒí™©ë³„ ëŒ€ì²˜</b>
    <button class="btn xs" onclick="togglePB()">ë‹«ê¸°</button>
  </div>
  <input id="pbq" class="pb-search" placeholder="ê²€ìƒ‰ (ì˜ˆ: ê¸°ë„íì‡„, í™”ìƒ, ê²½ë ¨)" oninput="filterCards(this.value)"/>
  <div id="pb-list" class="pb-list"></div>
  <div id="pb-view" class="pb-view"></div>
  <p class="pb-lic">â“˜ ì¶œì²˜Â·ë¼ì´ì„ ìŠ¤ëŠ” ê° ì¹´ë“œì— í‘œê¸°ë©ë‹ˆë‹¤.</p>
</aside>

<main class="wrap">
  <!-- ì±„íŒ… ì»¬ëŸ¼ -->
  <section class="col chat glass">
    <div id="chat" class="panel"></div>
    <div class="row">
      <input id="q" class="input" placeholder="ì¦ìƒì„ ì…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ë¡œ ë§ì”€í•˜ì„¸ìš” (ì˜ˆ: ê°€ìŠ´ í†µì¦, ì˜¤ë¥¸ìª½ ì•„ë«ë°° í†µì¦ ë“±)"/>
      <button class="btn send" onclick="send()">ì „ì†¡</button>
    </div>
    <p class="notice">â€» ë³¸ ì„œë¹„ìŠ¤ëŠ” ì •ë³´ ì œê³µìš©ì…ë‹ˆë‹¤. ì¦‰ì‹œ ìœ„í—˜ ì‹œ 119ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
  </section>

  <!-- ì‚¬ì´ë“œ ì»¬ëŸ¼ (ì˜¤ë¥¸ìª½): ë¹ ë¥¸ ì‘ê¸‰ì²˜ì¹˜ ìš”ì•½ â†’ ìƒë‹¨, ì´ë¯¸ì§€ â†’ í•˜ë‹¨ -->
  <aside class="col side">
    <div class="card glass firstaid" aria-label="ë¹ ë¥¸ ì‘ê¸‰ì²˜ì¹˜ ìš”ì•½">
      <div class="card-head">
        <svg class="ico ambu" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
          <path d="M3 16V7a1 1 0 0 1 1-1h6l3 3h7a1 1 0 0 1 1 1v6h-1a2 2 0 1 1-4 0H8a2 2 0 1 1-4 0H3zM8 10h2V8H8v2zm-1 8a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm12 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" fill="currentColor"/>
        </svg>
        <b>ë¹ ë¥¸ ì‘ê¸‰ì²˜ì¹˜ ìš”ì•½</b>
      </div>
      <ul class="bul">
        <li><b>ë°œì‘</b>: ì˜†ìœ¼ë¡œ ëˆ•íˆê³  ìœ„í—˜ë¬¼ ì¹˜ìš°ê¸°, ì…ì— ì•„ë¬´ê²ƒë„ ë„£ì§€ ì•Šê¸°, <b>5ë¶„â†‘ ì¦‰ì‹œ 119</b>.</li>
        <li><b>ì‹¬ê·¼ê²½ìƒ‰ ì˜ì‹¬</b>: 119, ì²˜ë°© ë‹ˆíŠ¸ë¡œ ìˆìœ¼ë©´ ì§€ì‹œì— ë”°ë¼ ë³µìš©, ë¬´í˜¸í¡Â·ë¬´ì˜ì‹ì´ë©´ <b>CPR</b>.</li>
        <li><b>ë‡Œì¡¸ì¤‘ FAST</b>: ì–¼êµ´Â·íŒ”Â·ë§ ì–´ëˆŒ â†’ <b>ì¦‰ì‹œ 119</b>.</li>
        <li><b>ê¸°ë„ ë§‰í˜(ì„±ì¸)</b>: ê¸°ì¹¨ ìœ ë„ â†’ íš¨ê³¼ ì—†ìœ¼ë©´ <b>ë³µë¶€ ë°€ì–´ë‚´ê¸°</b>, ì˜ì‹ ìƒìœ¼ë©´ CPR.</li>
        <li><b>ëŒ€ëŸ‰ì¶œí˜ˆ</b>: <b>ì§€ì••/ì••ë°•</b> ì§€ì†, ê°€ëŠ¥í•œ ë†’ì´ ì˜¬ë¦¬ê¸°, ì§€í˜ˆëŒ€ëŠ” êµìœ¡ë°›ì€ ê²½ìš°ë§Œ.</li>
        <li><b>ì•„ë‚˜í•„ë½ì‹œìŠ¤</b>: ì—í”¼íœ ì¦‰ì‹œ ì‚¬ìš©, ì¦ìƒ ì¬ë°œ ê°€ëŠ¥ â†’ 119/ì‘ê¸‰ì‹¤.</li>
        <li><b>í™”ìƒ</b>: ì—´ì› ì œê±°, <b>ë¯¸ì§€ê·¼í•œ ë¬¼ 20ë¶„</b> ëƒ‰ê°, ë¬¼ì§‘ì€ í„°ëœ¨ë¦¬ì§€ ì•Šê¸°.</li>
      </ul>
    </div>

    <div class="ai-art glass">
      <img src="/img/erimage.png"   alt="doctor"   class="art art1"/>
    </div>
  </aside>
</main>

<!-- í”Œë¡œíŒ… ë§ˆì´í¬ -->
<button id="fabMic" class="fab" title="ë§í•˜ê¸° ì‹œì‘/ì¢…ë£Œ" onclick="toggleSTT()">ğŸ¤</button>

<script>
const chat = document.getElementById('chat');
const sid = localStorage.getItem('sid') || (localStorage.setItem('sid','sid-'+Math.random().toString(36).slice(2)), localStorage.getItem('sid'));
let rec, recognizing=false;
let typingBubble=null;

// ìœ í‹¸
function addBubble(html, me=false){
  const b=document.createElement('div');
  b.className='bubble '+(me?'me':'bot');
  b.innerHTML=html;
  chat.appendChild(b); chat.scrollTop=chat.scrollHeight;
  return b;
}
function showTyping(){
  removeTyping();
  const b=document.createElement('div');
  b.className='bubble bot typing';
  b.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  typingBubble=b; chat.appendChild(b); chat.scrollTop=chat.scrollHeight;
}
function removeTyping(){ if(typingBubble){ typingBubble.remove(); typingBubble=null; } }

// 119
function tel119(){ location.href='tel:119'; }

// íƒ€ì´í•‘ íš¨ê³¼
function typeWriter(bubble, text, done){
  const speed = 14; let i=0;
  const timer=setInterval(()=>{
    bubble.innerHTML += (text[i]==='\n')?'<br/>':(text[i]||'');
    chat.scrollTop=chat.scrollHeight; i++;
    if(i>=text.length){ clearInterval(timer); done&&done(); }
  }, speed);
}

// ì „ì†¡ (assist_prompt ì˜µì…˜ ì§€ì›)
async function send(extra={}){
  const input=document.getElementById('q');
  const q=(extra.q ?? input.value).trim(); if(!q) return;
  input.value='';

  addBubble(q,true); showTyping();
  const lang=document.getElementById('lang').value;

  try{
    const body = { q, lang, session_id:sid };
    if(extra.assist_prompt){ body.assist_prompt = extra.assist_prompt; }

    const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)});
    const j=await r.json();
    removeTyping();

    if(j.alerts?.length){ addBubble(`<b class="warn">[ê²½ê³ ]</b> ${j.alerts.join(', ')}`); }

    const b=addBubble('',false);
    const text=(j.answer||'[ì‘ë‹µ ì—†ìŒ]').toString();
    typeWriter(b,text,()=>{ if(document.getElementById('ttsAuto').checked){ speak(b.innerText); } });

  }catch(e){
    removeTyping(); addBubble('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }
}

// STT
function toggleSTT(){
  if(!('webkitSpeechRecognition' in window)){ alert('Chrome ê¶Œì¥(ë§ˆì´í¬ ê¶Œí•œ í•„ìš”)'); return; }
  const btn=document.getElementById('btnSTT'); const fab=document.getElementById('fabMic');
  if(!rec){
    rec=new webkitSpeechRecognition(); rec.lang='ko-KR'; rec.interimResults=false; rec.continuous=false;
    rec.onresult=e=>{ document.getElementById('q').value=e.results[0][0].transcript; send(); };
    rec.onend=()=>{ recognizing=false; btn.innerText='ğŸ™ï¸ ë§í•˜ê¸°'; fab.classList.remove('on'); };
  }
  if(!recognizing){ recognizing=true; btn.innerText='â¹ï¸ ì¢…ë£Œ'; fab.classList.add('on'); rec.start(); }
  else{ recognizing=false; btn.innerText='ğŸ™ï¸ ë§í•˜ê¸°'; fab.classList.remove('on'); rec.stop(); }
}

// TTS
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text);
  const lang=document.getElementById('lang').value;
  u.lang=(lang==='ko')?'ko-KR':(lang==='en')?'en-US':(lang==='zh')?'zh-CN':'ja-JP';
  u.rate=0.95; speechSynthesis.cancel(); speechSynthesis.speak(u);
}

// Enter ì „ì†¡
document.getElementById('q').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); send(); }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í”Œë ˆì´ë¶(ìƒí™©ë³„ ëŒ€ì²˜) ë¡œì§
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let SCENARIOS = [];
function togglePB(){
  const el=document.getElementById('playbook');
  if(el.hasAttribute('hidden')){ el.removeAttribute('hidden'); loadScenarios(); }
  else{ el.setAttribute('hidden',''); }
}
async function loadScenarios(){
  if(SCENARIOS.length) return; // ìµœì´ˆ 1íšŒë§Œ
  const res = await fetch('/api/scenarios'); const j = await res.json();
  SCENARIOS = j.cards || []; renderCards(SCENARIOS);
}
function renderCards(arr){
  const box=document.getElementById('pb-list'); box.innerHTML="";
  arr.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='pb-card';
    btn.innerHTML = `<b>${c.title}</b><div class="mini">${(c.dept||[]).join('/')}</div>`;
    btn.onclick = ()=> openCard(c.id);
    box.appendChild(btn);
  });
}
function filterCards(q){
  q=(q||"").toLowerCase();
  const f=SCENARIOS.filter(c => c.title?.toLowerCase().includes(q));
  renderCards(f);
}
async function openCard(id){
  const res = await fetch(`/api/scenario/${id}`); const j = await res.json();
  if(!j.ok){ alert('ì¹´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
  const c=j.card; const view=document.getElementById('pb-view');
  view.innerHTML = `
    <div class="pb-card view">
      <div class="ttl">${c.title}</div>
      <ol class="steps">${(c.steps||[]).slice(0,10).map(s=>`<li>${s}</li>`).join("")}</ol>
      <div class="lic">ì¶œì²˜: ${c.source||""} Â· ${c.license||""}</div>
      <div class="row">
        <button class="btn xs" onclick="speak('${(c.title+" "+(c.steps||[]).slice(0,6).join('. ')).replace(/'/g,'\\\'')}')">ğŸ”ˆ ì½ì–´ì£¼ê¸°</button>
        <button class="btn xs primary" onclick="askWith('${encodeURIComponent(j.prompt)}')">ì´ê±¸ë¡œ ìƒë‹´</button>
      </div>
    </div>`;
}
function askWith(promptEncoded){
  const prompt = decodeURIComponent(promptEncoded);
  const input=document.getElementById('q');
  if(!input.value.trim()) input.value = "[ìƒí™© ì„ íƒ] "+(prompt.split('\n')[0]||'');
  send({ q: input.value, assist_prompt: prompt });
}
</script>

<!-- í”Œë ˆì´ë¶ ì „ìš© ìµœì†Œ CSS (ê¸°ì¡´ styles.cssì— ì˜í–¥ ìµœì†Œí™”) -->
<style>
  .pb { position: fixed; left: 12px; top: 78px; width: 320px; max-height: calc(100vh - 100px);
        overflow: auto; border-radius: 14px; padding: 12px; z-index: 20; }
  .pb-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .pb-search { width:100%; padding:10px 12px; border:2px solid #22c09a77; border-radius:12px; font-size:15px; }
  .pb-list { margin-top:8px; }
  .pb-card { display:block; width:100%; text-align:left; padding:10px 12px; margin:6px 0;
             border:2px solid #22c09a; background:#e9fff7; border-radius:12px; font-weight:700; }
  .pb-card.view { background:#fff; border-style:dashed }
  .pb-card .mini { font-size:12px; color:#088178; font-weight:500; }
  .pb-view .ttl { font-weight:900; margin:10px 2px; color:#045d56; }
  .pb-view .steps { margin:6px 2px 8px 18px; }
  .pb-view .lic { font-size:11px; color:#666; margin:6px 2px; }
  .btn.xs { padding:6px 10px; font-size:12px; border-radius:10px; }
  .btn.primary { background:#22c09a; color:#fff; border-color:#22c09a; }
</style>
</body>
</html>
