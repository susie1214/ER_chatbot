<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ER-NOW 119 (ì‘ê¸‰ì²˜ì¹˜ ë„ìš°ë¯¸)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #009688;
      --bg: #f4f7f6;
      --text: #333;
      --text-light: #666;
      --border: #ddd;
      --accent: #e63946;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* í—¤ë” */
    .hdr {
      background: white;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      z-index: 10;
    }

    .brand {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-center {
      display: flex;
      gap: 8px;
    }

    .nav-btn {
      background: none;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: #ffebee;
      color: var(--primary);
    }

    .right-ctrl {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn-119 {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      cursor: pointer;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(230, 57, 70, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(230, 57, 70, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(230, 57, 70, 0);
      }
    }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
    .wrap {
      flex: 1;
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      padding: 20px;
      gap: 20px;
      overflow: hidden;
    }

    .col {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .side {
      width: 320px;
      flex-shrink: 0;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* ì¢Œì¸¡ í”Œë ˆì´ë¶ */
    .pb-panel {
      background: #fff;
    }

    .pb-head {
      padding: 20px;
      font-weight: 700;
      border-bottom: 1px solid var(--border);
      color: var(--primary);
    }

    .pb-search {
      margin: 10px 20px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .pb-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px 20px;
    }

    .pb-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pb-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .pb-card b {
      display: block;
      margin-bottom: 4px;
      color: var(--text);
    }

    .pb-card .mini {
      font-size: 12px;
      color: var(--text-light);
    }

    /* ì±„íŒ… íŒ¨ë„ */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #fafafa;
    }

    .input-area {
      padding: 20px;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-box {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }

    .btn-send {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }

    .bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      line-height: 1.5;
      position: relative;
    }

    .bubble.bot {
      background: white;
      border: 1px solid var(--border);
      align-self: flex-start;
      border-top-left-radius: 2px;
    }

    .bubble.me {
      background: var(--primary);
      color: white;
      align-self: flex-end;
      margin-left: auto;
      border-top-right-radius: 2px;
    }

    .bubble b.warn {
      color: var(--accent);
    }

    /* ìš°ì¸¡ ìš”ì•½ íŒ¨ë„ */
    .summary-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--accent);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .summary-head {
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .summary-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      list-style: none;
    }

    .summary-list li {
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* ì˜¤ë²„ë ˆì´ (PHR, ë³‘ì›) */
    .overlay {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(244, 247, 246, 0.98);
      z-index: 100;
      padding: 40px;
      overflow-y: auto;
      display: none;
    }

    .overlay.open {
      display: block;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .ov-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 30px;
      min-height: 80vh;
    }

    .ov-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .ov-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .btn-close {
      background: none;
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }

    /* PHR ìŠ¤íƒ€ì¼ */
    .phr-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .phr-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .phr-label {
      font-weight: 700;
      margin-bottom: 12px;
      display: block;
      color: #555;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .form-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .btn-sm {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-del {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
    }

    .btn-del:hover {
      color: var(--accent);
    }

    .hosp-item {
      border: 1px solid #eee;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .hosp-item:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 150, 136, 0.1);
    }

    .hosp-name {
      font-weight: 700;
      font-size: 16px;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .hosp-addr {
      font-size: 14px;
      color: #666;
    }

    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      z-index: 200;
    }

    .fab:hover {
      transform: scale(1.1);
    }

    .fab.recording {
      background: var(--accent);
      animation: pulse 1.5s infinite;
    }

    .map-container {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      margin-bottom: 20px;
      z-index: 1;
    }

    .hosp-filter {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .warning-val {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <header class="hdr">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM11 17H9V13H5V11H9V7H11V11H15V13H11V17Z" />
      </svg>
      ER-NOW 119
    </div>
    <div class="nav-center">
      <button class="nav-btn active" onclick="closeOverlay()">ğŸ’¬ ìƒë‹´ì‹¤</button>
      <button class="nav-btn" onclick="openOverlay('phr')">ğŸ“‹ ë‚˜ì˜ ì°¨íŠ¸</button>
      <button class="nav-btn" onclick="openOverlay('hospital')">ğŸ¥ ë³‘ì› ì°¾ê¸°</button>
    </div>
    <div class="right-ctrl">
      <div style="font-size:14px; color:#666;">
        <label><input type="checkbox" id="ttsAuto" checked> ğŸ”ˆìŒì„±ì•ˆë‚´</label>
      </div>
      <button class="btn-119" onclick="location.href='tel:119'">ğŸš¨ 119 ì‹ ê³ </button>
    </div>
  </header>

  <main class="wrap">
    <!-- ì¢Œì¸¡: í”Œë ˆì´ë¶ -->
    <aside class="col side pb-panel">
      <div class="pb-head">ğŸ“š ì‘ê¸‰ ìƒí™©ë³„ ëŒ€ì²˜</div>
      <input id="pbq" class="pb-search" placeholder="ìƒí™© ê²€ìƒ‰ (ì˜ˆ: ì‹¬ì •ì§€, í™”ìƒ)" oninput="filterCards(this.value)">
      <div id="pb-list" class="pb-list"></div>
    </aside>

    <!-- ì¤‘ì•™: ì±„íŒ… -->
    <section class="main">
      <div id="chat" class="chat-area">
        <div class="bubble bot">
          ì•ˆë…•í•˜ì„¸ìš”! <b>119 ì‘ê¸‰ì²˜ì¹˜ ë„ìš°ë¯¸</b>ì…ë‹ˆë‹¤.<br>
          ì–´ë””ê°€ ë¶ˆí¸í•˜ì‹ ê°€ìš”? ì¦ìƒì„ ë§ì”€í•´ ì£¼ì‹œê±°ë‚˜ ì™¼ìª½ì—ì„œ ìƒí™©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
        </div>
      </div>
      <div class="input-area">
        <input id="q" class="input-box" placeholder="ì¦ìƒì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê°€ìŠ´ì´ ì¡°ì´ë“¯ ì•„íŒŒìš”)">
        <button class="btn-send" onclick="send()">ì „ì†¡</button>
      </div>
    </section>

    <!-- ìš°ì¸¡: ìš”ì•½ -->
    <aside class="col side">
      <div class="summary-card">
        <div class="summary-head">âš¡ ë¹ ë¥¸ ì‘ê¸‰ì²˜ì¹˜ ìš”ì•½</div>
        <ul class="summary-list">
          <li><b>ì‹¬ì •ì§€</b>: ğŸ“¢ "ë„ì™€ì£¼ì„¸ìš”!" 119 ì‹ ê³  â†’ <b>ê°€ìŠ´ì••ë°•</b> (ë¶„ë‹¹ 100~120íšŒ)</li>
          <li><b>ê¸°ë„íì‡„</b>: ê¸°ì¹¨ ìœ ë„ â†’ ë“± ë‘ë“œë¦¬ê¸° â†’ <b>í•˜ì„ë¦¬íˆë²•</b></li>
          <li><b>ë‡Œì¡¸ì¤‘</b>: ğŸš‘ <b>FAST</b> (ì–¼êµ´ ì²˜ì§, íŒ” ë§ˆë¹„, ë§ ì–´ëˆŒ) â†’ ì¦‰ì‹œ 119</li>
          <li><b>ì‹¬ê·¼ê²½ìƒ‰</b>: ğŸ’” ì¥ì–´ì§œëŠ” í‰í†µ, ì‹ì€ë•€ â†’ <b>119 ì‹ ê³ </b>, í¸ì•ˆí•œ ìì„¸</li>
          <li><b>í™”ìƒ</b>: ğŸ§Š íë¥´ëŠ” ì‹œì›í•œ ë¬¼ì— <b>15~20ë¶„</b> ì‹íˆê¸° (ì–¼ìŒ X)</li>
          <li><b>ì¶œí˜ˆ</b>: ğŸ©¸ ê¹¨ë—í•œ ì²œ/ê±°ì¦ˆë¡œ ìƒì²˜ ë¶€ìœ„ <b>ì§ì ‘ ì••ë°•</b></li>
          <li><b>ê³¨ì ˆ</b>: ğŸ¦´ ì›€ì§ì´ì§€ ì•Šê²Œ <b>ë¶€ëª© ê³ ì •</b>, ëƒ‰ì°œì§ˆ</li>
          <li><b>ë²Œ ì˜ì„</b>: ğŸ ì¹´ë“œ ë“±ìœ¼ë¡œ ì¹¨ ì œê±°, ëƒ‰ì°œì§ˆ, í˜¸í¡ê³¤ë€ ì‹œ 119</li>
          <li><b>ì—´ì‚¬ë³‘</b>: â˜€ï¸ ì‹œì›í•œ ê³³ ì´ë™, ì˜· ëŠìŠ¨í•˜ê²Œ, ë¬¼ ë¿Œë¦¬ê¸°</li>
          <li><b>ì˜ìœ ì•„ ê³ ì—´</b>: ğŸŒ¡ï¸ ë¯¸ì˜¨ìˆ˜ ë§ˆì‚¬ì§€, í•´ì—´ì œ, ê²½ë ¨ ì‹œ 119</li>
        </ul>
      </div>
    </aside>
  </main>

  <!-- PHR ì˜¤ë²„ë ˆì´ -->
  <div id="overlay-phr" class="overlay">
    <div class="ov-container">
      <div class="ov-head">
        <div class="ov-title">ğŸ“‹ ë‚˜ì˜ ê±´ê°•ê¸°ë¡ (My Chart)</div>
        <button class="btn-close" onclick="closeOverlay()">ë‹«ê¸°</button>
      </div>

      <div class="phr-grid">
        <!-- ì¢Œì¸¡: í”„ë¡œí•„ ë° ì…ë ¥ -->
        <div class="col">
          <div class="phr-section">
            <label class="phr-label">ê¸°ë³¸ í”„ë¡œí•„</label>
            <div class="form-row">
              <input id="phr-name" class="form-input" placeholder="ì´ë¦„">
              <input id="phr-birth" class="form-input" placeholder="ìƒë…„ì›”ì¼ (YYYY-MM-DD)">
            </div>
            <div class="form-row">
              <select id="phr-gender" class="form-input">
                <option value="">ì„±ë³„</option>
                <option value="M">ë‚¨ì„±</option>
                <option value="F">ì—¬ì„±</option>
              </select>
              <input id="phr-blood" class="form-input" placeholder="í˜ˆì•¡í˜•">
            </div>
            <button class="btn-sm btn-primary" style="width:100%" onclick="saveProfile()">í”„ë¡œí•„ ì €ì¥</button>
          </div>

          <div class="phr-section">
            <label class="phr-label">ê±´ê°• ìˆ˜ì¹˜ ê¸°ë¡</label>
            <div class="form-row">
              <select id="metric-type" class="form-input">
                <option value="í˜ˆì••(ìˆ˜ì¶•ê¸°)">í˜ˆì••(ìˆ˜ì¶•ê¸°)</option>
                <option value="í˜ˆì••(ì´ì™„ê¸°)">í˜ˆì••(ì´ì™„ê¸°)</option>
                <option value="ê³µë³µí˜ˆë‹¹">ê³µë³µí˜ˆë‹¹</option>
                <option value="ì²´ì¤‘">ì²´ì¤‘</option>
              </select>
              <input id="metric-val" class="form-input" type="number" placeholder="ìˆ˜ì¹˜">
              <button class="btn-sm btn-primary" onclick="addMetric()">ê¸°ë¡</button>
            </div>
            <div id="metric-list" style="max-height: 200px; overflow-y: auto;"></div>
          </div>
        </div>

        <!-- ìš°ì¸¡: ê·¸ë˜í”„ -->
        <div class="col">
          <div class="phr-section" style="height: 100%; min-height: 400px;">
            <label class="phr-label">ê±´ê°• ì¶”ì„¸ ê·¸ë˜í”„</label>
            <canvas id="phrChart"></canvas>
          </div>
        </div>
      </div>

      <div class="phr-grid" style="margin-top: 24px;">
        <div class="phr-section">
          <label class="phr-label">ì§„ë£Œ/ìˆ˜ìˆ  ì´ë ¥</label>
          <div class="form-row">
            <input id="hist-hosp" class="form-input" placeholder="ë³‘ì›ëª…">
            <input id="hist-dept" class="form-input" placeholder="ì§„ë£Œê³¼">
          </div>
          <div class="form-row">
            <input id="hist-date" class="form-input" placeholder="ë‚ ì§œ (YYYY-MM-DD)">
            <button class="btn-sm btn-primary" onclick="addHistory()">ì¶”ê°€</button>
          </div>
          <div id="hist-list"></div>
        </div>

        <div class="phr-section">
          <label class="phr-label">ë³´í—˜ ì •ë³´</label>
          <div class="form-row">
            <input id="ins-name" class="form-input" placeholder="ë³´í—˜ì‚¬/ìƒí’ˆëª…">
            <button class="btn-sm btn-primary" onclick="addInsurance()">ì¶”ê°€</button>
          </div>
          <div id="ins-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë³‘ì› ì°¾ê¸° ì˜¤ë²„ë ˆì´ -->
  <div id="overlay-hospital" class="overlay">
    <div class="ov-container">
      <div class="ov-head">
        <div class="ov-title">ğŸ¥ ë‚´ ì£¼ë³€ ë³‘ì› ì°¾ê¸°</div>
        <button class="btn-close" onclick="closeOverlay()">ë‹«ê¸°</button>
      </div>

      <div class="hosp-filter">
        <button class="btn-sm btn-primary" onclick="getMyLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ ì¤‘ì‹¬ ê²€ìƒ‰ (ë¶„ë‹¹)</button>
        <select id="hosp-dept" class="form-input" style="max-width: 200px;"
          onchange="searchHospitals(currentLat, currentLng)">
          <option value="">ì „ì²´ ì§„ë£Œê³¼</option>
          <option value="ë‚´ê³¼">ë‚´ê³¼</option>
          <option value="ì™¸ê³¼">ì™¸ê³¼</option>
          <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
          <option value="ì„±í˜•ì™¸ê³¼">ì„±í˜•ì™¸ê³¼</option>
          <option value="ì‚°ë¶€ì¸ê³¼">ì‚°ë¶€ì¸ê³¼</option>
          <option value="ì†Œì•„ì²­ì†Œë…„ê³¼">ì†Œì•„ì²­ì†Œë…„ê³¼</option>
          <option value="ì‘ê¸‰ì˜í•™ê³¼">ì‘ê¸‰ì˜í•™ê³¼</option>
        </select>
      </div>

      <!-- ì§€ë„ ì˜ì—­ -->
      <div id="map" class="map-container"></div>

      <div id="hosp-status" style="margin-bottom: 10px; font-weight: 700; color: var(--primary);"></div>
      <div id="hosp-result" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>
    </div>
  </div>

  <button id="fabMic" class="fab" onclick="toggleSTT()">ğŸ¤</button>
  <button id="fabStop" class="fab" style="bottom: 100px; background: #757575;" onclick="stopTTS()">â¹ï¸</button>

  <script>
    // --- PHR Logic ---
    async function loadPHR() {
      try {
        const res = await fetch('/api/phr');
        const data = await res.json();

        // Profile
        if (data.profile) {
          document.getElementById('phr-name').value = data.profile.name || '';
          document.getElementById('phr-birth').value = data.profile.birthdate || '';
          document.getElementById('phr-gender').value = data.profile.gender || '';
          document.getElementById('phr-blood').value = data.profile.blood_type || '';
        }

        // Metrics
        const mList = document.getElementById('metric-list');
        mList.innerHTML = '';
        (data.metrics || []).forEach((m, i) => {
          const d = document.createElement('div');
          d.className = 'hosp-item';
          d.style.padding = '8px';
          d.innerHTML = `<b>${m.type}</b>: ${m.value} <span style="font-size:12px;color:#999">(${m.date})</span> <button class="btn-del" onclick="delPHR('metrics', ${i})">x</button>`;
          mList.appendChild(d);
        });

        // Chart
        renderChart(data.metrics || []);

        // History
        const hList = document.getElementById('hist-list');
        hList.innerHTML = '';
        (data.history || []).forEach((h, i) => {
          const d = document.createElement('div');
          d.className = 'hosp-item';
          d.style.padding = '8px';
          d.innerHTML = `<b>${h.hospital}</b> (${h.dept}) <br><span style="font-size:12px;color:#666">${h.date}</span> <button class="btn-del" onclick="delPHR('history', ${i})">x</button>`;
          hList.appendChild(d);
        });

        // Insurance
        const iList = document.getElementById('ins-list');
        iList.innerHTML = '';
        (data.insurance || []).forEach((ins, i) => {
          const d = document.createElement('div');
          d.className = 'hosp-item';
          d.style.padding = '8px';
          d.innerHTML = `<b>${ins.name}</b> <button class="btn-del" onclick="delPHR('insurance', ${i})">x</button>`;
          iList.appendChild(d);
        });
      } catch (e) {
        console.error("Failed to load PHR", e);
      }
    }

    let phrChart;
    function renderChart(metrics) {
      const ctx = document.getElementById('phrChart').getContext('2d');
      if (phrChart) phrChart.destroy();

      // Group by type
      const dataMap = {};
      metrics.forEach(m => {
        if (!dataMap[m.type]) dataMap[m.type] = [];
        dataMap[m.type].push({ x: m.date, y: parseFloat(m.value) });
      });

      const datasets = Object.keys(dataMap).map((key, idx) => ({
        label: key,
        data: dataMap[key],
        borderColor: ['#009688', '#e63946', '#f4a261', '#2a9d8f'][idx % 4],
        fill: false,
        tension: 0.1
      }));

      phrChart = new Chart(ctx, {
        type: 'line',
        data: { labels: metrics.map(m => m.date), datasets }, // Simplified labels for now
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false } // Hide x axis labels if too many
          }
        }
      });
    }

    async function saveProfile() {
      const body = {
        name: document.getElementById('phr-name').value,
        birthdate: document.getElementById('phr-birth').value,
        gender: document.getElementById('phr-gender').value,
        blood_type: document.getElementById('phr-blood').value
      };
      await fetch('/api/phr/profile', { method: 'POST', body: JSON.stringify(body) });
      alert('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    async function addMetric() {
      const type = document.getElementById('metric-type').value;
      const value = document.getElementById('metric-val').value;
      if (!value) return;
      await fetch('/api/phr/metric', { method: 'POST', body: JSON.stringify({ type, value }) });
      loadPHR();
    }

    async function addHistory() {
      const hospital = document.getElementById('hist-hosp').value;
      const dept = document.getElementById('hist-dept').value;
      const date = document.getElementById('hist-date').value;
      if (!hospital) return;
      await fetch('/api/phr/history', { method: 'POST', body: JSON.stringify({ hospital, dept, date }) });
      loadPHR();
    }

    async function addInsurance() {
      const name = document.getElementById('ins-name').value;
      if (!name) return;
      await fetch('/api/phr/insurance', { method: 'POST', body: JSON.stringify({ name }) });
      loadPHR();
    }

    async function delPHR(cat, idx) {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await fetch(`/api/phr/${cat}/${idx}`, { method: 'DELETE' });
      loadPHR();
    }

    // --- Hospital Search Logic ---
    let map, markers = [];
    let currentLat = 37.3518; // Default Bundang
    let currentLng = 127.1236;

    function initMap() {
      if (map) return;
      map = L.map('map').setView([currentLat, currentLng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    async function getMyLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          currentLat = pos.coords.latitude;
          currentLng = pos.coords.longitude;
          if (map) map.setView([currentLat, currentLng], 14);
          searchHospitals(currentLat, currentLng);
        }, () => {
          alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìœ„ì¹˜(ë¶„ë‹¹)ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.');
          searchHospitals(currentLat, currentLng);
        });
      } else {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    }

    async function searchHospitals(lat, lng) {
      const dept = document.getElementById('hosp-dept').value;
      const res = await fetch(`/api/hospitals/nearby?lat=${lat}&lng=${lng}&dept=${dept}`);
      const data = await res.json();

      // Clear markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const list = document.getElementById('hosp-result');
      list.innerHTML = '';
      document.getElementById('hosp-status').innerText = `ê²€ìƒ‰ ê²°ê³¼: ${data.hospitals.length}ê±´`;

      data.hospitals.forEach(h => {
        // Add marker
        const m = L.marker([h.lat, h.lng]).addTo(map)
          .bindPopup(`<b>${h.yadmNm}</b><br>${h.dept.join(', ')}`);
        markers.push(m);

        // Add list item
        const d = document.createElement('div');
        d.className = 'hosp-item';
        d.innerHTML = `
          <div class="hosp-name">${h.yadmNm}</div>
          <div class="hosp-addr">${h.addr}</div>
          <div style="font-size:12px; color:#009688; margin-top:4px;">${h.dept.join(', ')}</div>
          <div style="font-size:13px; margin-top:4px;">ğŸ“ ${h.telno}</div>
        `;
        d.onclick = () => {
          map.setView([h.lat, h.lng], 16);
          m.openPopup();
        };
        list.appendChild(d);
      });
    }

    // --- Overlay Logic ---
    function openOverlay(id) {
      document.querySelectorAll('.overlay').forEach(el => el.classList.remove('open'));
      document.getElementById('overlay-' + id).classList.add('open');
      if (id === 'hospital') {
        setTimeout(() => {
          initMap();
          map.invalidateSize();
          searchHospitals(currentLat, currentLng);
        }, 100);
      } else if (id === 'phr') {
        loadPHR();
      }
    }

    function closeOverlay() {
      document.querySelectorAll('.overlay').forEach(el => el.classList.remove('open'));
    }

    // --- Chat & Playbook Logic ---
    const chat = document.getElementById('chat');
    const sid = localStorage.getItem('sid') || (localStorage.setItem('sid', 'sid-' + Math.random().toString(36).slice(2)), localStorage.getItem('sid'));
    let rec, recognizing = false;

    function addBubble(html, me = false) {
      const b = document.createElement('div');
      b.className = 'bubble ' + (me ? 'me' : 'bot');
      b.innerHTML = html;
      chat.appendChild(b); chat.scrollTop = chat.scrollHeight;
      return b;
    }

    async function send(extra = {}) {
      const input = document.getElementById('q');
      const q = (extra.q ?? input.value).trim(); if (!q) return;
      input.value = '';
      addBubble(q, true);

      // íƒ€ì´í•‘ íš¨ê³¼
      const typing = addBubble('<span class="dot">...</span>', false);

      try {
        const body = { q, lang: 'ko', session_id: sid };
        if (extra.assist_prompt) body.assist_prompt = extra.assist_prompt;

        const r = await fetch('/api/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        });
        const j = await r.json();

        typing.remove();
        if (j.alerts?.length) addBubble(`<b class="warn">[ê²½ê³ ]</b> ${j.alerts.join(', ')}`);

        const b = addBubble('', false);
        typeWriter(b, j.answer || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.', () => {
          if (document.getElementById('ttsAuto').checked) speak(j.answer);
        });
      } catch (e) { typing.remove(); addBubble('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    function typeWriter(el, text, done) {
      let i = 0; el.innerHTML = "";
      const timer = setInterval(() => {
        el.innerHTML += (text[i] === '\n' ? '<br>' : text[i] || '');
        chat.scrollTop = chat.scrollHeight; i++;
        if (i >= text.length) { clearInterval(timer); done && done(); }
      }, 10);
    }

    // STT/TTS
    function toggleSTT() {
      if (!('webkitSpeechRecognition' in window)) { alert('Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.'); return; }
      const fab = document.getElementById('fabMic');
      if (!rec) {
        rec = new webkitSpeechRecognition(); rec.lang = 'ko-KR';
        rec.onresult = e => { document.getElementById('q').value = e.results[0][0].transcript; send(); };
        rec.onend = () => { recognizing = false; fab.classList.remove('recording'); };
      }
      if (!recognizing) { recognizing = true; fab.classList.add('recording'); rec.start(); }
      else { recognizing = false; fab.classList.remove('recording'); rec.stop(); }
    }

    function speak(text) {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ko-KR'; speechSynthesis.speak(u);
    }

    function stopTTS() {
      window.speechSynthesis.cancel();
    }

    // Playbook
    let SCENARIOS = [];
    async function loadScenarios() {
      const res = await fetch('/api/scenarios'); const j = await res.json();
      SCENARIOS = j.cards || []; renderCards(SCENARIOS);
    }
    function renderCards(arr) {
      const box = document.getElementById('pb-list'); box.innerHTML = "";
      arr.forEach(c => {
        const d = document.createElement('div'); d.className = 'pb-card';
        d.innerHTML = `<b>${c.title}</b><div class="mini">${(c.dept || []).join('/')}</div>`;
        d.onclick = async () => {
          const r = await fetch(`/api/scenario/${c.id}`); const j = await r.json();
          send({ q: `[ìƒí™© ì„ íƒ] ${c.title}`, assist_prompt: j.prompt });
        };
        box.appendChild(d);
      });
    }
    function filterCards(q) {
      renderCards(SCENARIOS.filter(c => c.title.includes(q)));
    }

    // Init
    loadScenarios();
    document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') send() });
  </script>
</body>

</html>